CREATE EXTENSION postgis;

CREATE TABLE topology (
    id_topology SERIAL PRIMARY KEY,
    name VARCHAR(255),
    links INTEGER,
    nodes INTEGER,
    area GEOMETRY(POLYGON, 4326)  -- Definir el tipo y SRID para la columna 'area'
);

CREATE TABLE nodes (
    id_topology INTEGER,
    id_node INTEGER,
    lat FLOAT,
    lon FLOAT,
    point GEOMETRY(POINT, 4326),  -- Definir el tipo y SRID para la columna 'point'
    PRIMARY KEY (id_topology, id_node),
    FOREIGN KEY (id_topology) REFERENCES topology(id_topology)
);

CREATE TABLE new_nodes (
    id_topology INTEGER,
    id_node SERIAL,
    lat FLOAT,
    lon FLOAT,
    point GEOMETRY(POINT, 4326),
    PRIMARY KEY (id_node),
    FOREIGN KEY (id_topology) REFERENCES topology(id_topology)
);

CREATE TABLE new_links (
    id_link SERIAL PRIMARY KEY,
    id_topology INTEGER,
    source_topology INTEGER,
    source INTEGER,
    target INTEGER,
    distance FLOAT,
    geom GEOMETRY(LINESTRING, 4326),
    FOREIGN KEY (id_topology) REFERENCES topology(id_topology),
    FOREIGN KEY (source_topology, source) REFERENCES nodes(id_topology, id_node),
    FOREIGN KEY (target) REFERENCES new_nodes(id_node)
);

CREATE TABLE links (
    id_topology INTEGER,
    id_link INTEGER,
    source INTEGER,
    target INTEGER,
    geom GEOMETRY(LINESTRING, 4326),  -- Definir el tipo y SRID para la columna 'geom'
    PRIMARY KEY (id_topology, id_link),
    FOREIGN KEY (id_topology) REFERENCES topology(id_topology),
    FOREIGN KEY (id_topology, source) REFERENCES nodes(id_topology, id_node),
    FOREIGN KEY (id_topology, target) REFERENCES nodes(id_topology, id_node)
);

CREATE TABLE link_probabilities (
    link_id INTEGER,
    failure_probability FLOAT
);

CREATE TABLE routes (
    id SERIAL PRIMARY KEY,
    id_topology INTEGER,
    source INTEGER,
    target INTEGER,
    path_type VARCHAR(255),
    geom GEOMETRY(LINESTRING, 4326),
    FOREIGN KEY (id_topology) REFERENCES topology(id_topology),
    FOREIGN KEY (id_topology, source) REFERENCES nodes(id_topology, id_node),
    FOREIGN KEY (id_topology, target) REFERENCES nodes(id_topology, id_node)
);

INSERT INTO topology ("name",links,nodes,area) VALUES
	 ('Italia',61,32,'SRID=4326;POLYGON ((14.959765218646844 38.09201049508317, 14.958441260863289 38.09191389625722, 13.359688301096112 38.11131621310767, 13.358730089012203 38.11138482502197, 13.357801261969211 38.111580011113944, 9.134701547567252 39.20337505037029, 9.133642966743189 39.20371491953767, 9.132693543175987 39.20421053142055, 9.13189056973526 39.20484241985615, 9.131265589605782 39.20558576565127, 9.130843157212338 39.206411371019165, 8.554587306075074 40.72591653830977, 8.554398975715388 40.72657974720372, 7.680521811799673 45.06979115136202, 7.680449025652283 45.07065910824248, 7.68061619266984 45.07152076971872, 7.681017027292019 45.07234368207453, 7.681636441567655 45.07309684963565, 7.6824511121018295 45.073751902477895, 7.683430357626123 45.07428416540048, 7.684537294269089 45.074673587834006, 9.18731952100024 45.4684854703783, 9.188704873068778 45.46871963093083, 11.924769165489884 45.67774508865438, 11.926030323787087 45.67773953826162, 11.927265797612419 45.677562284208996, 11.928428064567823 45.677220144360426, 11.929472419924508 45.6767262788141, 12.330788193798481 45.44204725657844, 12.33177217568308 45.441321720551656, 16.424456895322685 41.27925738136454, 16.424966996954783 41.27856342111933, 16.8030389152774 40.62826822898882, 16.803359597313204 40.62755032425494, 16.803517345230883 40.62680126020411, 16.803507682998326 40.62604231772877, 16.59427634467616 38.90572917891107, 16.594068891065998 38.904880867099585, 16.593658731300998 38.90407843096286, 16.593060912442024 38.9033512952184, 16.59229736096548 38.90272612246005, 15.556932481865108 38.19089323045763, 15.55612999322967 38.19042373781006, 15.555237133531035 38.19007134572189, 15.554281130374699 38.189846799737104, 14.959765218646844 38.09201049508317))');

INSERT INTO nodes (id_topology,id_node,lat,lon,point) VALUES
	 (1,1,40.72722,8.56028,'SRID=4326;POINT (8.560279846191406 40.72721862792969)'),
	 (1,2,39.20768,9.136422,'SRID=4326;POINT (9.136422157287598 39.207679748535156)'),
	 (1,3,38.11582,13.35976,'SRID=4326;POINT (13.359760284423828 38.115821838378906)'),
	 (1,4,38.09642,14.958615,'SRID=4326;POINT (14.95861530303955 38.09642028808594)'),
	 (1,5,38.194263,15.553166,'SRID=4326;POINT (15.553166389465332 38.19426345825195)'),
	 (1,6,38.90613,16.588541,'SRID=4326;POINT (16.58854103088379 38.906131744384766)'),
	 (1,7,40.626453,16.797625,'SRID=4326;POINT (16.797624588012695 40.6264533996582)'),
	 (1,8,41.27673,16.41951,'SRID=4326;POINT (16.419509887695312 41.276729583740234)'),
	 (1,9,40.64432,15.80857,'SRID=4326;POINT (15.80856990814209 40.64432144165039)'),
	 (1,10,41.460415,15.542898,'SRID=4326;POINT (15.542898178100586 41.46041488647461)');
INSERT INTO nodes (id_topology,id_node,lat,lon,point) VALUES
	 (1,11,40.67797,14.76599,'SRID=4326;POINT (14.765990257263184 40.67797088623047)'),
	 (1,12,40.83333,14.25,'SRID=4326;POINT (14.25 40.83332824707031)'),
	 (1,13,42.455124,14.21697,'SRID=4326;POINT (14.216970443725586 42.45512390136719)'),
	 (1,14,42.35352,13.397687,'SRID=4326;POINT (13.397686958312988 42.353519439697266)'),
	 (1,15,41.862045,12.39052,'SRID=4326;POINT (12.390520095825195 41.86204528808594)'),
	 (1,16,43.59816,13.51008,'SRID=4326;POINT (13.510080337524414 43.59815979003906)'),
	 (1,17,43.09674,12.38286,'SRID=4326;POINT (12.38286018371582 43.09674072265625)'),
	 (1,18,42.436203,11.207311,'SRID=4326;POINT (11.207310676574707 42.43620300292969)'),
	 (1,19,43.76667,11.25,'SRID=4326;POINT (11.25 43.76667022705078)'),
	 (1,20,43.71553,10.39659,'SRID=4326;POINT (10.396590232849121 43.71553039550781)');
INSERT INTO nodes (id_topology,id_node,lat,lon,point) VALUES
	 (1,21,44.49381,11.33875,'SRID=4326;POINT (11.338749885559082 44.49380874633789)'),
	 (1,22,45.43861,12.32667,'SRID=4326;POINT (12.326669692993164 45.4386100769043)'),
	 (1,23,45.673275,11.925363,'SRID=4326;POINT (11.925362586975098 45.673274993896484)'),
	 (1,24,45.43094,10.977295,'SRID=4326;POINT (10.977294921875 45.430938720703125)'),
	 (1,25,45.52478,10.22727,'SRID=4326;POINT (10.227270126342773 45.5247802734375)'),
	 (1,26,44.793083,10.319943,'SRID=4326;POINT (10.31994342803955 44.79308319091797)'),
	 (1,27,45.46427,9.18951,'SRID=4326;POINT (9.189510345458984 45.464271545410156)'),
	 (1,28,45.18446,9.16145,'SRID=4326;POINT (9.161450386047363 45.1844596862793)'),
	 (1,29,44.40632,8.93386,'SRID=4326;POINT (8.933859825134277 44.40631866455078)'),
	 (1,30,44.90034,8.217477,'SRID=4326;POINT (8.217476844787598 44.90034103393555)');
INSERT INTO nodes (id_topology,id_node,lat,lon,point) VALUES
	 (1,31,45.07049,7.68682,'SRID=4326;POINT (7.686820030212402 45.070491790771484)'),
	 (1,32,43.894558,8.032959,'SRID=4326;POINT (8.032958984375 43.89455795288086)');

INSERT INTO links (id_topology,id_link,"source",target,geom) VALUES
	 (1,1,1,2,'SRID=4326;LINESTRING (8.560279846191406 40.72721862792969, 9.136422157287598 39.207679748535156)'),
	 (1,2,2,3,'SRID=4326;LINESTRING (9.136422157287598 39.207679748535156, 13.359760284423828 38.115821838378906)'),
	 (1,3,3,4,'SRID=4326;LINESTRING (13.359760284423828 38.115821838378906, 14.95861530303955 38.09642028808594)'),
	 (1,4,3,5,'SRID=4326;LINESTRING (13.359760284423828 38.115821838378906, 14.25 40.83332824707031)'),
	 (1,5,4,6,'SRID=4326;LINESTRING (14.95861530303955 38.09642028808594, 15.553166389465332 38.19426345825195)'),
	 (1,6,4,7,'SRID=4326;LINESTRING (14.95861530303955 38.09642028808594, 14.765990257263184 40.67797088623047)'),
	 (1,7,6,7,'SRID=4326;LINESTRING (15.553166389465332 38.19426345825195, 14.765990257263184 40.67797088623047)'),
	 (1,8,6,8,'SRID=4326;LINESTRING (15.553166389465332 38.19426345825195, 16.58854103088379 38.906131744384766)'),
	 (1,9,8,7,'SRID=4326;LINESTRING (16.58854103088379 38.906131744384766, 14.765990257263184 40.67797088623047)'),
	 (1,10,8,9,'SRID=4326;LINESTRING (16.58854103088379 38.906131744384766, 15.80856990814209 40.64432144165039)');
INSERT INTO links (id_topology,id_link,"source",target,geom) VALUES
	 (1,11,8,10,'SRID=4326;LINESTRING (16.58854103088379 38.906131744384766, 16.797624588012695 40.6264533996582)'),
	 (1,12,10,11,'SRID=4326;LINESTRING (16.797624588012695 40.6264533996582, 16.419509887695312 41.276729583740234)'),
	 (1,13,10,9,'SRID=4326;LINESTRING (16.797624588012695 40.6264533996582, 15.80856990814209 40.64432144165039)'),
	 (1,14,10,12,'SRID=4326;LINESTRING (16.797624588012695 40.6264533996582, 15.542898178100586 41.46041488647461)'),
	 (1,15,11,9,'SRID=4326;LINESTRING (16.419509887695312 41.276729583740234, 15.80856990814209 40.64432144165039)'),
	 (1,16,11,12,'SRID=4326;LINESTRING (16.419509887695312 41.276729583740234, 15.542898178100586 41.46041488647461)'),
	 (1,17,9,12,'SRID=4326;LINESTRING (15.80856990814209 40.64432144165039, 15.542898178100586 41.46041488647461)'),
	 (1,18,9,7,'SRID=4326;LINESTRING (15.80856990814209 40.64432144165039, 14.765990257263184 40.67797088623047)'),
	 (1,19,12,5,'SRID=4326;LINESTRING (15.542898178100586 41.46041488647461, 14.25 40.83332824707031)'),
	 (1,20,12,13,'SRID=4326;LINESTRING (15.542898178100586 41.46041488647461, 14.216970443725586 42.45512390136719)');
INSERT INTO links (id_topology,id_link,"source",target,geom) VALUES
	 (1,21,7,5,'SRID=4326;LINESTRING (14.765990257263184 40.67797088623047, 14.25 40.83332824707031)'),
	 (1,22,5,14,'SRID=4326;LINESTRING (14.25 40.83332824707031, 12.390520095825195 41.86204528808594)'),
	 (1,23,5,15,'SRID=4326;LINESTRING (14.25 40.83332824707031, 13.397686958312988 42.353519439697266)'),
	 (1,24,13,16,'SRID=4326;LINESTRING (14.216970443725586 42.45512390136719, 13.510080337524414 43.59815979003906)'),
	 (1,25,13,15,'SRID=4326;LINESTRING (14.216970443725586 42.45512390136719, 13.397686958312988 42.353519439697266)'),
	 (1,26,15,14,'SRID=4326;LINESTRING (13.397686958312988 42.353519439697266, 12.390520095825195 41.86204528808594)'),
	 (1,27,15,17,'SRID=4326;LINESTRING (13.397686958312988 42.353519439697266, 12.38286018371582 43.09674072265625)'),
	 (1,28,14,18,'SRID=4326;LINESTRING (12.390520095825195 41.86204528808594, 11.207310676574707 42.43620300292969)'),
	 (1,29,14,19,'SRID=4326;LINESTRING (12.390520095825195 41.86204528808594, 10.396590232849121 43.71553039550781)'),
	 (1,30,16,17,'SRID=4326;LINESTRING (13.510080337524414 43.59815979003906, 12.38286018371582 43.09674072265625)');
INSERT INTO links (id_topology,id_link,"source",target,geom) VALUES
	 (1,31,16,20,'SRID=4326;LINESTRING (13.510080337524414 43.59815979003906, 12.326669692993164 45.4386100769043)'),
	 (1,32,16,21,'SRID=4326;LINESTRING (13.510080337524414 43.59815979003906, 11.338749885559082 44.49380874633789)'),
	 (1,33,17,22,'SRID=4326;LINESTRING (12.38286018371582 43.09674072265625, 11.25 43.76667022705078)'),
	 (1,34,17,18,'SRID=4326;LINESTRING (12.38286018371582 43.09674072265625, 11.207310676574707 42.43620300292969)'),
	 (1,35,18,19,'SRID=4326;LINESTRING (11.207310676574707 42.43620300292969, 10.396590232849121 43.71553039550781)'),
	 (1,36,22,19,'SRID=4326;LINESTRING (11.25 43.76667022705078, 10.396590232849121 43.71553039550781)'),
	 (1,37,22,21,'SRID=4326;LINESTRING (11.25 43.76667022705078, 11.338749885559082 44.49380874633789)'),
	 (1,38,19,23,'SRID=4326;LINESTRING (10.396590232849121 43.71553039550781, 9.161450386047363 45.1844596862793)'),
	 (1,39,19,24,'SRID=4326;LINESTRING (10.396590232849121 43.71553039550781, 8.933859825134277 44.40631866455078)'),
	 (1,40,19,25,'SRID=4326;LINESTRING (10.396590232849121 43.71553039550781, 10.31994342803955 44.79308319091797)');
INSERT INTO links (id_topology,id_link,"source",target,geom) VALUES
	 (1,41,21,25,'SRID=4326;LINESTRING (11.338749885559082 44.49380874633789, 10.31994342803955 44.79308319091797)'),
	 (1,42,21,26,'SRID=4326;LINESTRING (11.338749885559082 44.49380874633789, 10.977294921875 45.430938720703125)'),
	 (1,43,21,20,'SRID=4326;LINESTRING (11.338749885559082 44.49380874633789, 12.326669692993164 45.4386100769043)'),
	 (1,44,20,27,'SRID=4326;LINESTRING (12.326669692993164 45.4386100769043, 11.925362586975098 45.673274993896484)'),
	 (1,45,20,26,'SRID=4326;LINESTRING (12.326669692993164 45.4386100769043, 10.977294921875 45.430938720703125)'),
	 (1,46,27,26,'SRID=4326;LINESTRING (11.925362586975098 45.673274993896484, 10.977294921875 45.430938720703125)'),
	 (1,47,27,28,'SRID=4326;LINESTRING (11.925362586975098 45.673274993896484, 10.227270126342773 45.5247802734375)'),
	 (1,48,27,28,'SRID=4326;LINESTRING (11.925362586975098 45.673274993896484, 10.227270126342773 45.5247802734375)'),
	 (1,49,26,28,'SRID=4326;LINESTRING (10.977294921875 45.430938720703125, 10.227270126342773 45.5247802734375)'),
	 (1,50,26,25,'SRID=4326;LINESTRING (10.977294921875 45.430938720703125, 10.31994342803955 44.79308319091797)');
INSERT INTO links (id_topology,id_link,"source",target,geom) VALUES
	 (1,51,28,29,'SRID=4326;LINESTRING (10.227270126342773 45.5247802734375, 9.189510345458984 45.464271545410156)'),
	 (1,52,25,24,'SRID=4326;LINESTRING (10.31994342803955 44.79308319091797, 8.933859825134277 44.40631866455078)'),
	 (1,53,29,23,'SRID=4326;LINESTRING (9.189510345458984 45.464271545410156, 9.161450386047363 45.1844596862793)'),
	 (1,54,29,30,'SRID=4326;LINESTRING (9.189510345458984 45.464271545410156, 7.686820030212402 45.070491790771484)'),
	 (1,55,23,31,'SRID=4326;LINESTRING (9.161450386047363 45.1844596862793, 8.217476844787598 44.90034103393555)'),
	 (1,56,24,30,'SRID=4326;LINESTRING (8.933859825134277 44.40631866455078, 7.686820030212402 45.070491790771484)'),
	 (1,57,24,31,'SRID=4326;LINESTRING (8.933859825134277 44.40631866455078, 8.217476844787598 44.90034103393555)'),
	 (1,58,24,32,'SRID=4326;LINESTRING (8.933859825134277 44.40631866455078, 8.032958984375 43.89455795288086)'),
	 (1,59,31,30,'SRID=4326;LINESTRING (8.217476844787598 44.90034103393555, 7.686820030212402 45.070491790771484)'),
	 (1,60,30,32,'SRID=4326;LINESTRING (7.686820030212402 45.070491790771484, 8.032958984375 43.89455795288086)');
INSERT INTO links (id_topology,id_link,"source",target,geom) VALUES
	 (1,61,32,1,'SRID=4326;LINESTRING (8.032958984375 43.89455795288086, 8.560279846191406 40.72721862792969)');

-- Consulta para visualizar --
SELECT
    t.name AS topology_name,
    n.id_node,
    n.lat,
    n.lon,
    ST_AsText(n.point) AS node_point, -- Convertimos el punto a texto para visualización
    l.id_link,
    l.source,
    l.target,
    l.geom AS link_geom -- Conservamos el formato geométrico original
FROM
    topology t
JOIN
    nodes n ON t.id_topology = n.id_topology
JOIN
    links l ON n.id_topology = l.id_topology
WHERE
    n.id_node = l.source OR n.id_node = l.target
ORDER BY
    l.id_link, n.id_node;
